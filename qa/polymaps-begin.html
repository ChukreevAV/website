<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Начало работы с Polymaps</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Вопросы и ответы</a></li>
</ul>
<!--Contents start-->
<script src="https://raw.github.com/simplegeo/polymaps/master/polymaps.min.js"></script>
<h1>Начало работы с Polymaps</h1>
<p class="ann">Знакомство с библиотекой Polymaps</p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8033"--></span></p>
<p>Библиотека OpenLayers благодаря своим широким возможностям стала стандартом де-факто при разработке свободных картографических web-приложений. Однако, недавний скачок роста использования Интернета на мобильных устройствах привёл к появлению новых библиотек, демонстрирующих совершенно иной подход. Хотя OpenLayers, начиная с версии 2.11, добился значительного прогресса в вопросе поддержки мобильных устройств, новые библиотеки, такие как Polymaps, <a href="http://www.tile5.org/" target="_blank" class="external">Tile5</a> и <a href="http://leaflet.cloudmade.com/" target="_blank" class="external">Leaflet</a> изначально разрабатывались с ориентацией на современные технологии, в том числе и на работу в мобильных приложениях.</p>
<p>В данной статье мы рассмотрим одну из этих новых библиотек, а именно продукт совместной работы <a href="http://stamen.com/" target="_blank" class="external">Stamen Design</a> и <a href="https://simplegeo.com/" target="_blank" class="external">SimpleGeo</a> - <a href="http://polymaps.org/" target="_blank" class="external">Polymaps</a>.</p>
            <p><strong>Оглавление</strong></p>
            <ol>
                  <li><a href="#01">Особенности библиотеки</a></li>
                  <li><a href="#02">Подключение библиотеки и основные подходы к использованию</a></li>
                  <li><a href="#03">Практическое применение</a></li>
                  <li><a href="#04">Заключение</a></li>
            </ol>

<!-- Первый раздел -->
            <h2><strong><a name="01" id="01"></a></strong>1. Особенности библиотеки</h2>
            <p>Polymaps - это небольшая (32 Кб, что в 30 раз меньше OpenLayers в оригинальной сборке) JavaScript библиотека с открытым исходным кодом, предназначенная для создания интерактивных web-карт. Главной особенностью библиотеки является возможность работы с векторными данными больших объёмов. Это достигается за счёт применения тайлового подхода к векторным SVG-изображениям и автоматического изменения детализации геометрий при переходе между масштабными уровнями. В качестве единственного поддерживаемого формата векторных данных в Polymaps используется <a href="http://gis-lab.info/docs/geojson_ru.html" target="_blank">GeoJSON</a>.</p>
	    <p>Как уже было отмечено выше, Polymaps ориентирован на работу с масштабируемой векторной графикой (Scalable Vector Graphics, SVG). Многие из существующих библиотек web-картографии обременены поддержкой совместимости с устаревшими браузерами в которых отсутствует поддержка SVG (здесь важно отметить, что поскольку поддержка SVG появилась только в IE9, то в предыдущих версиях указанного браузера Polymaps работать не будет). Выбор же в качестве рендера SVG позволяет Polymaps выполнять широкий спектр графических операций, а также даёт возможность настраивать внешний вид объектов с помощью CSS.</p>
	    <p>Для обеспечения высокой производительности при работе с большими объёмами данных в Polymaps используется ряд специальных стратегий. Во-первых, все тайлы, и растровые и векторные, кэшируются, поэтому если потребуется какой-то из уже использованных ранее тайлов, он будет получен из кэша, а не через запрос к серверу. Во-вторых, если нужный тайл недоступен в кэше, но доступны тайлы соседних масштабных уровней на этот участок, то они могут быть временно использованы до тех пор, пока нужный тайл не придёт с сервера. Такой подход позволяет обеспечить плавность сдвига и изменения масштаба.</p>

<!-- Второй раздел -->
            <h2><strong><a name="02" id="02"></a></strong>2. Подключение библиотеки и основные подходы к использованию</h2>
            <p>Для получения библиотеки необходимо перейти на <a href="http://polymaps.org/" target="_blank" class="external">главную страницу</a> и скачать последнюю версию, на настоящий момент это <a href="http://github.com/simplegeo/polymaps/zipball/v2.5.0" target="_blank" class="external">2.5.0</a>. Для подключения Polymaps, необходимо в разделе head html-страницы указать путь до файла библиотеки polymaps.js или polymaps.min.js (минифицированный вариант).</p>
	    <p>Каждое приложение Polymaps начинается с создания объекта map. Но прежде чем его создавать, необходимо импортировать пространство имён Polymaps в какую-нибудь локальную переменную, например:</p>
	    <pre>var po = org.polymaps;</pre>
	    <p>После чего можно переходить непосредственно к созданию объекта map:</p>
	    <pre>var map = po.map();</pre>
	    <p>Отметим, что библиотека не использует традиционный JavaScript конструктор new, вместо этого Polymaps предоставляет <a href="http://ru.wikipedia.org/wiki/%D0%A4%D0%B0%D0%B1%D1%80%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BC%D0%B5%D1%82%D0%BE%D0%B4_%28%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%29" target="_blank" class="external">фабричные методы</a>, автоматически создающие необходимые объекты.</p>
	    <p>Все методы объекта map возвращают сам объект, поэтому работа с Polymaps предполагает активное использование цепочек методов. Например:</p>
	    <pre>var map = po.map().container(document.body.appendChild(po.svg("svg"))).add(po.image().url(…));</pre>
	    <p>Это одна команда, которая создаёт объект map, выделяет под него контейнер и добавляет растровый слой. В случае, если карта содержит несколько слоёв, они будут отрисовываны снизу вверх (<a href="http://en.wikipedia.org/wiki/Painter%27s_algorithm" target="_blank" class="external">алгоритм художника</a>):</p>
	    <pre>var map = po.map()
   .container(document.body.appendChild(po.svg("svg")))
   .add(po.image().url("grid.png")) //Нижний слой
   .add(po.image().url(…)); //Верхний слой</pre>
   <p>При работе со слоями также используются цепочки методов, позволяющие конфигурировать слои одновременно с добавлением их на карту. URL слоя может быть либо статическим (например, в случае использования растрового файла), либо динамическим. В последнем случае составляется шаблон URL с использованием подстановочных переменных: </p>
   <ul>
       <li>{X} - номер столбца тайловой разбивки;</li>
       <li>{Y} - номер строки тайловой разбивки;</li>
       <li>{B} - охват;</li>
       <li>{Z} - масштабный уровень;</li>
       <li>{S} - хост.</li>
   </ul>
   <p>Синтаксис добавления векторного GeoJSON слоя похож на синтаксис добавления растровой подложки:</p>
   <pre>var map = po.map()
   .container(document.body.appendChild(po.svg("svg")))
   .add(po.image().url(…)) //Растровый слой
   .add(po.geoJson().url(…)); //Векторный слой</pre>
   <p>По умолчанию создаваемая карта неинтерактивна. Для придания ей элементов интерактивности необходимо добавить контролы взаимодействия с пользователем:</p>
   <pre>var map = po.map()
   .container(document.body.appendChild(po.svg("svg")))
   .add(po.image())
   .add(po.interact());</pre>
   <p>Контрол interact представляет собой обобщенный вызов пяти различных контролов:</p>
   <pre>var map = po.map()
   .container(document.body.appendChild(po.svg("svg")))
   .add(po.image())
   .add(po.arrow())
   .add(po.drag())
   .add(po.dblclick())
   .add(po.touch()) </pre>
   <p>Контрол arrow отвечает за сдвиг карты с помощью клавиш стрелок и изменение масштаба с помощью клавиш "+" и "-", контрол drag -  за сдвиг карты с помощью мыши, контрол dblclick позволяет приблизить карту по двойному клику, контрол wheel отвечает за изменение масштаба карты при вращении колеса мыши и, наконец, контрол touch отвечает за работу с мобильными устройствами.</p>

    <h2><strong><a name="03" id="03"></a></strong>3. Практическое применение</h2>
    <p>На официальном сайте Polymaps представлен <a href="http://polymaps.org/ex/" target="_blank" class="external">ряд примеров</a> использования библиотеки. Кроме того, в архиве с библиотекой представлено еще около 30 примеров, некоторые из которых дублируют примеры с сайта. Рассмотрим пару простых примеров, наглядно иллюстрирующих использование Polymaps для создания интерактивных карт.</p>
    <strong>Подключение подложки CloudMade</strong>
    <p></p>
    <p>Подложка <a href="http://maps.cloudmade.com/editor" target="_blank" class="external">CloudMade</a>, представляет собой различные стили оформления данных проекта <a href="http://www.openstreetmap.org/" target="_blank" class="external">OpenStreetMap</a>.</p>
        
        
    <!-- Polymaps example 1 -->
    <div id="map" style="height: 300px; width: 700px;"></div>
    <script type="text/javascript">
      var po = org.polymaps;
      var map = po.map()
        .container(document.getElementById("map").appendChild(po.svg("svg")))
        .center({lat: 55.0276, lon: 82.9241})
        .zoom(13)
        .add(po.interact())
        .add(po.hash())
        .add(po.image()
        .url(po.url("http://{S}tile.cloudmade.com"
        + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
        + "/999/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""])));
    </script>
    <p></p> 
    <p>Код представленной карты:</p>
    <pre>&lt;html&gt;
  &lt;head&gt;
    &lt;style type="text/css"&gt;
      #map {height: 300px; width: 700px;}
    &lt;/style&gt;
    &lt;script type="text/javascript" src="polymaps/polymaps.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="map"&gt;&lt;/div&gt;
    &lt;script type="text/javascript"&gt;
      var po = org.polymaps;
      var map = po.map()
        .container(document.getElementById("map").appendChild(po.svg("svg")))
        .center({lat: 55.0276, lon:82.9241})
        .zoom(13)
        .add(po.interact())
        .add(po.hash())
        .add(po.image()
        .url(po.url("http://{S}tile.cloudmade.com"
        + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
        + "/999/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""])));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>

<p>Рассмотрим представленный код более подробно. Импорт пространства имён Polymaps:</p>
<pre>var po = org.polymaps;</pre>
<p>Создание объекта map:</p>
<pre>var map = po.map()</pre>
<p>Создание контейнера в который будет добавлена карта:</p>
<pre>.container(document.getElementById("map").appendChild(po.svg("svg")))</pre>
<p>Установка центра карты:</p>
<pre>.center({lat: 55.0276, lon: 82.9241})</pre>
<p>Задание масштабного уровня:</p>
<pre>.zoom(13)</pre>
<p>Добавление контролов взаимодействия с пользователем:</p>
<pre>.add(po.interact())</pre>
<p>Добавление контрола hash:</p>
<pre>add(po.hash())</pre>
<p>Данный контрол позволяет автоматически изменять URL карты при сдвиге и изменении масштаба, тем самым даёт возможность легкого создания постоянных ссылок на участки карты (Permalink).</p>
<p>Добавление подложки CloudMade:</p>
<pre>add(po.image()
  .url(po.url("http://{S}tile.cloudmade.com"
  + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
  + "/999/256/{Z}/{X}/{Y}.png")
  .hosts(["a.", "b.", "c.", ""])));</pre>
<p>В последней команде интересен метод hosts объекта po.url. Данный метод принимает на вход массив строк, используемых для валидации подстановочной переменной {S} в строке URL. То есть в нашем случае, допустимыми адресами тайлов могут быть:</p>
<pre>http://a.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/999/256/13/6002/2657.png
http://b.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/999/256/13/6003/2657.png
http://c.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/999/256/13/6004/2657.png
http://tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/999/256/13/6001/2657.png</pre>

<strong>Добавление векторного слоя</strong><p></p>
<p>Рассмотрим простой пример визуализации статического GeoJSON файла.</p>

    <!-- Polymaps example 2 -->
    <style type="text/css">
      #map {
          height: 400px;
          width: 400px;
        }
      #russia path {
          fill: lightsteelblue;
          fill-opacity: .8;
          stroke: FireBrick;
        }
    </style>
    <div id="map-geojson" style="height: 300px; width: 700px;"></div>
    <script type="text/javascript">
      var mapjson = po.map()
        .container(document.getElementById("map-geojson").appendChild(po.svg("svg")))
        .center({lat: 68, lon: 91.4})
        .zoom(2)
        .add(po.interact());
        
      mapjson.add(po.image()
        .url(po.url("http://{S}tile.cloudmade.com"
        + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
        + "/7/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""])));
      
      mapjson.add(po.geoJson()
        .url("../other/federal-districts.geojson")
        .id("russia"));
    </script>
    <p></p>
    <p>Код представленной карты:</p>
    <pre>&lt;html&gt;
  &lt;head&gt;
    &lt;style type="text/css"&gt;
      #map {
          height: 400px;
          width: 400px;
        }
      #russia path {
          fill: lightsteelblue;
          fill-opacity: .8;
          stroke: FireBrick;
        }
    &lt;/style&gt;
    &lt;script type="text/javascript" src="polymaps/polymaps.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="map-geojson"&gt;&lt;/div&gt;
    &lt;script type="text/javascript"&gt;
      var po = org.polymaps;
      var map = po.map()
        .container(document.getElementById("map-geojson").appendChild(po.svg("svg")))
        .center({lat: 68, lon: 91.4})
        .zoom(2)
        .add(po.interact());
        
      map.add(po.image()
        .url(po.url("http://{S}tile.cloudmade.com"
        + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
        + "/7/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""])));
      
      map.add(po.geoJson()
        .url("../other/federal-districts.geojson")
        .id("russia"));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>
<p>По сравнению с предыдущим примером добавилась одна команда:</p>
<pre>map.add(po.geoJson()
  .url("federal-districts.geojson")
  .id("russia"));</pre>
<p>Данной командой мы добавляем на карту слой federal-districts.geojson и присваиваем слою идентификатор "russia". Данный идентификатор используется в качестве CSS-селектора при настройке символики слоя:</p>
<pre>#russia path {
  fill: lightsteelblue;
  fill-opacity: .8;
  stroke: FireBrick;
}</pre>
<p>В рассмотренном примере не использовалась техника векторных тайлов, файл загружался целиком. Вопросу разбивки и передачи векторных данных в виде тайлов и анализу увеличения производительности в этом случае мы планируем посвятить одну из следующих статей.</p>

<h2><strong><a name="04" id="04"></a></strong>4. Заключение</h2>
<p>Подводя итог, можно сделать вывод о том, что Polymaps - это графический фреймворк, позволяющий работать с большими объемами векторных данных за счет использования тайловой техники и настраивать символику геометрических объектов с помощью каскадных таблиц стилей (CSS). Однако, отсутствие поддержки широкого спектра источников пространственных данных (в том числе WFS, WMS), инструментов редактирования, ограниченный список поддерживаемых браузеров (Polymaps гарантированно работает только в Chrome 6+, Safari 4+ и Firefox 3.6 и гарантированно не работает в версиях MS Internet Explorer младше 9) накладывают некоторые ограничения для создания функциональных картографических приложений.</p>
<!--Contents end-->

<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8033"--></span></p>
<div class="links">
	<h2>Ссылки по теме</h2>
		<ul>
			<li><a href="http://polymaps.org/ex/" target="_blank" class="external">Официальный сайт Polymaps</a></li>
			<li><a href="http://polymaps.org/ex/" target="_blank" class="external">Примеры использования Polymaps</a></li>
			<li><a href="http://www.aaronland.info/talks/where2011/#1" target="_blank" class="external">Презентация, посвященная Polymaps</a></li>
		</ul>
</div>
<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 15.06.2011
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=6901" target="_blank">Денис Рыков</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
