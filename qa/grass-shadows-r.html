<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Выделение теней от облаков на данных ДЗЗ с помощью ГИС GRASS</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Статьи</a></li>
</ul>
<!--Contents start-->
<h1>Построение масок теней от облаков на данных ДЗЗ с помощью ГИС GRASS</h1>
<p class="ann">Как сделать маску теней </p>
<p>Статья продолжает серию публикаций, посвященную использованию ГИС GRASS для мониторинга природных процессов. Ранее на эту тему
  были опубликованы статьи <a href="grass-r.html">Анализ данных с использованием ГИС GRASS и R</a> и <a href="grass-neuro-r.html">Нейросетевая обработка данных в ГИС GRASS и R</a></p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=7649"--></span></p>

<p><strong>Оглавление</strong></p>
<ol>
	  <li><a href="#01">Описание задачи</a></li>
	  <li><a href="#02">Реализация</a></li>
</ol>

<!-- Первый раздел -->
<h2><strong><a name="01" id="01"></a></strong>1. Описание задачи</h2>
<p>Облака и тени от облаков затрудняют анализ поверхности Земли по данным ДЗЗ, поскольку они искажают спектральные характеристики
поверхности. Поэтому предварительно созданые маски облаков и их теней могут в дальнейшем облегчить решение основной задачи, стоящей перед исследователем. 
</p>
<p>В данной статье дается пример использования связки геоинформационной системы GRASS и аналитического пакета R для построения масок
облаков и их теней. В виду того, что построения маски теней - более сложная задача, чем построение маски облачности, в данной статье
основной упор будет сделан на задачу поиска теней.
</p>
<p>В качестве примера рассмотрим конкретный снимок A2000.109, для которого будет строится маска, представленый ниже (композитное изображение ближнего инфракрасного и красного каналов, данные MODIS):
</p>
<p class="ill"><a href="/images/grass-shadows-r-01.png"><img alignclass="size-medium wp-image-76" src="/images/grass-shadows-r-01b.png" alt="" width="252" height="300" /></a>
<span>Исходное композитное RGB изображение, синтез 1-2-1, данные MODIS. Видна облачность разного типа в северной части снимка. Щелкните на изображении для увеличения. </span></p>
<!-- Второй раздел -->
<h2><strong><a name="02" id="02"></a></strong>2. Реализация</h2>

<p>Как видно, на снимке довольно много мелких облаков и, соответственно, теней, поэтому строить маску вручную - долго и утомительно. Выделять тени автоматически, на основе их спектральных характеристик также довольно хлопотно, т.к. эти характеристики меняются в зависимости от того, на какую поверхность упала тень. Поэтому для ускорения работы воспользуемся ранее <a href="http://gis-lab.info/qa/grass-neuro-r.html">описанным методом</a> поиска изменений. Для этого выберем близкий по времени снимок с меньшим числом облаков (A2000.105):
</p>
<p class="ill">
<a href="/images/grass-shadows-r-02.png"><img class="alignnone size-medium wp-image-78" src="/images/grass-shadows-r-02b.png" alt="Композитное изображение (1-2-1)" width="252" height="300" /></a>
<span>Второе исходное композитное RGB изображение, синтез 1-2-1, 3 апреля 2000, данные MODIS. Щелкните на изображении для увеличения.</span></p>

<p>
Далее была построена нейронная сеть, которая была обучена по данным второго изображения (A2000.105) возвращать значения первого (A2000.109). В результате были получены две разности (для каждого канала в отдельности) между реальным и ожидаемым значением dif1 и dif2:
</p>
<p class="ill">
<a href="/images/grass-shadows-r-03.png"><img class="size-medium wp-image-79" src="/images/grass-shadows-r-03b.png" alt="Композитное rgb изображение разностей (dif1-dif2-dif1)" width="252" height="300" /></a>
<span>Производное изобрежение. Щелкните на изображении для увеличения.</span></p>

<p>
На этом изображении на сером фоне хорошо просматриваются облака и их тени. Далее нужно подобрать какой-либо разумный порог, по которому можно отделить тень от фона. Однако, при внимательном рассмотрении становится понятно, что такого порога не существует.
</p>

<p>
Дело в том, что облако на полученном изображении выглядит как "белое пятно", а тень - как "черное пятно". Черные пятна получаются там, где ожидаемые значения выше, чем полученные из нейронной сети. Для рассматриваемых снимков по большей части справедливо то, что, если в реальности на каком-либо участке снимка яркость меньше, чем предсказано сетью, то это произошло потому, что на данный участок упала тень. Но есть исключение: темное пятно появится и в случае, если на входном снимке было облако - тогда значение, предсказанное сетью также больше, чем в реальности.
</p>

<p>На фрагменте композитного изображения, составленного из разностей, видна полоса, темная часть которой соответствует участку снимка A2000.105, закрытого облаком:
<p class="ill">
<a href="/images/grass-shadows-r-04.png"><img class="size-medium wp-image-81" src="/images/grass-shadows-r-04b.png" alt="" width="300" height="225" /></a>
<span>Фрагмент производного изображения с ошибочной областью. Щелкните на изображении для увеличения.</span></p>

</p>

<p>
Таким образом, какой порог бы мы не подбирали для при анализе разностей ﻿﻿﻿dif1 и dif2, в получившуюся маску будут попадать также и участки, закрытые облаками на снимке﻿ A2000.105. Чтобы отсечь этот случай, при выделении теней потребуется анализировать не два растра (dif1 и dif2), а как минимум три (﻿dif1, dif2 и A2000.105.1 - первый канал снимка A2000.105).
</p>

<p>
Для автоматизации построения маски теней произведем совместную классификацию трех изображений dif1, dif2 и A2000.105.1. на основе классификации без обучения.
</p>

<p>В ГИС GRASS  классификация производится в два этапа:</p>
<ul>
	<li>Генерируются спектральные сигнатуры на основе алгоритма кластеризации. Существует несколько модулей, генерирующих сигнатуры, мы воспользуемся <a href="http://grass.gis-lab.info/grass64/manuals/html64_user/i.cluster.html">i.cluster</a>.</li>
	<li>На основе полученных сигнатур производится собственно классификация,  будем использовать метод максимального правдоподобия <a href="http://grass.gis-lab.info/grass64/manuals/html64_user/i.maxlik.html">i.maxlik</a>.</li>
</ul>

<h2>Классификация</h2>

<p>В ГИС GRASS  перед классификацией изображений необходимо сначала создать группу, в которую войдут изображения, предназначенные для анализа.</p>
<pre># Сгруппируем растры для анализа:
i.group group=teni subgroup=day2000.109 in=dif1,dif.2,norm_A2000.109.1</pre>


<p>
Модуль i.cluster принимает несколько параметров, влияющих на качество классификации. В первую очередь, это начальное количество кластеров (classes), степень устойчивости получаемых кластеров (convergence) и порог, согласно которому кластеры могут быть объеденены в один (separation). Создадим файл сигнатур teni5, начальное число кластеров положим равным пяти, остальные параметры оставим по умолчанию:
</p>

<pre>i.cluster group=teni subgr=day2000.109 sigfile=teni5 class=5</pre>

<p>В результате был получен следующий файл сигнатур:</p>

<pre>#produced by i.cluster
#Class 1
373
-0.12203 -0.241684 0.376518
0.00844029
0.00233836 0.0136008
-0.00448385 -0.00433758 0.0196701
#Class 2
1918
-0.00415582 0.0130466 0.33635
0.00683429
0.00219023 0.00673684
0.000368992 -0.00033016 0.00399067
#Class 3
1564
0.0116323 0.0108282 0.543228
0.0078622
0.00168063 0.00564052
-0.000900678 -0.000136028 0.00490507
#Class 4
880
0.048829 0.0377407 0.820891
0.015089
0.00750132 0.0125422
0.000641942 -0.000832052 0.00859291
#Class 5
643
0.525218 0.370767 0.396278
0.0129791
0.00806127 0.0236968
-0.00599599 0.000977332 0.0138644</pre>

<p>
Каждый выделенный класс описан средними значениями и матрицей ковариаций (на примере первого класса):
</p>

<pre>373  # число примеров обучающего множества, отнесенных к данному классу
-0.12203 -0.241684 0.376518  # средние значения пикселей класса для растров dif1,dif2 и norm_A2000.109.1 соответственно
# матрица ковариаций:
0.00844029
0.00233836 0.0136008
-0.00448385 -0.00433758 0.0196701</pre>


<p>
Далее производим собственно классификацию, для этого передадим модулю полученный файл сигнатур:
</p>

<pre>i.maxlik group=teni subgr=day2000.109 sigfile=teni5 clas=cluster5_2000.109 --o</pre>

<p>Результат (фрагмент центрального участка) можно посмотреть на следующем рисунке:
</p>
<p class="ill">
<a href="/images/grass-shadows-r-05.png"><img class="size-medium wp-image-87" src="/images/grass-shadows-r-05b.png" alt="" width="300" height="138" /></a>
<span>Результат классификации, фрагмент . Щелкните на изображении для увеличения.</span></p>

<p>
Для большей наглядности можно установить прозрачность для всех классов, кроме 1-го и подложить снимок:
</p>
<p class="ill">
<a href="/images/grass-shadows-r-06.png"><img class="size-medium wp-image-88" src="/images/grass-shadows-r-06b.png" alt="" width="300" height="138" /></a>
<span>Результат классификации, класс теней наложенный на снимок. Щелкните на изображении для увеличения.</span></p>

<p>и</p>
<p class="ill">
<a href="/images/grass-shadows-r-07.png"><img class="alignnone size-medium wp-image-91" src="/images/grass-shadows-r-07b.png" alt="" width="300" height="138" /></a>
<span>Результат классификации, класс теней наложенный на снимок, нижняя часть, ошибки на востоке. Щелкните на изображении для увеличения.</span></p>

<p>
Чисто визуально - большая часть теней распознана правильно, темная полоса, которая ошибочно воспринималась как тень на растрах dif1 и dif2, не была выделена в класс теней, однако, в восточной части участка есть области, которые явно ошибочно отнесены к разряду теней. Если внимательно посмотреть на исходные снимки, то становится понятным, то эти области - водные объекты - множество мелких озер-ильменей. Поэтому для более корректной классификации можно попробовать два пути:</p>

<ol>
	<li>Изменить параметры кластеризации (по идее вода должна хорошо отделяться).</li>
	<li>Добавить к анализируемым изображениям растр, хранящий маску воды.</li>
</ol>

<p>Первый путь проще, с него и начнем:
</p>

<pre>i.cluster group=teni subgr=day2000.109 sigfile=teni20 class=20 con=99.5
i.maxlik group=teni subgr=day2000.109 sigfile=teni20 clas=cluster20_2000.109 --o</pre>

<p>Результат показан ниже:
</p>
<p class="ill">
<a href="/images/grass-shadows-r-08.png"><img src="/images/grass-shadows-r-08b.png" alt="" width="300" height="138" /></a>
<span>Окончательная классификация, класс теней наложенный на снимок. Щелкните на изображении для увеличения.</span></p>

<p>
Как видим, в результате были отсечены ложные срабатывания на участках, покрытых водой - теперь они не относятся к классу теней.
</p>


<!-- обсуждение на форуме, цифра изменяется при публикации статьи -->   
<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=7649"--></span></p>
<!-- ссылки -->
<div class="links">
	<h2>Ссылки по теме</h2>
		<ul>
			<li><a href="grass-r.html">Анализ данных с использованием GRASS GIS и R</a></li>
			<LI><a href="grass-neuro-r.html">Нейросетевая обработка данных в ГИС GRASS и R</a></LI>
			</ul>
</div>


<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 09.01.2011
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=6597" target="_blank">Дмитрий Колесов</a>, <a href="/forum/memberlist.php?mode=viewprofile&u=2" target="_blank">Максим Дубинин</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
