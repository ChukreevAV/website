<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Нейросетевая обработка данных в ГИС GRASS и R</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Статьи</a></li>
</ul>
<!--Contents start-->
<h1>Нейросетевая обработка данных в ГИС GRASS и R</h1>
<p class="ann">Совместного использования ГИС GRASS и статистического пакета R.</p>
<p>Данная статья продолжает публикацию <a href="grass-r.html">Анализ данных с использованием GRASS GIS и R</a>, посвященную теме совместного использования ГИС GRASS и статистического пакета R.</p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=7175"--></span></p>

<p>В данной статье рассматривается пример использования нейросетевого пакета <a href="http://rwiki.sciviews.org/doku.php?id=packages:cran:amore">AMORE</a> и анализ данных в ГИС GRASS.</p>
<p><strong>Оглавление</strong></p>
<ol>
	  <li><a href="#01">Описание задачи</a></li>
	  <li><a href="#02">Реализация</a></li>
</ol>

<!-- Первый раздел -->
<h2><strong><a name="01" id="01"></a></strong>1. Описание задачи</h2>

<p>Процесс нейросетевого анализа данных GRASS GIS рассмотрим на примере конкретной задачи:</p>

<p><strong>Описание задачи:</strong> даны снимки одной и той же территории, сделанные в разное время. Предполагается, что некоторая (в процентном соотношении небольшая) часть территории за время, прошедшее между съемками, подверглась изменению. Нужно определить участки изменений.</p>

<p><strong>Ход решения:</strong> берем пару последовательных снимков и строим регрессию - по первому снимку предсказываем значения второго снимка. Условие того, что изменению подверглась незначительная часть территории позволяет надеяться, что:</p>
<ul>
	<li>предсказание второго снимка по первому может быть довольно точным</li>
	<li>те участки, для которых заметно значительное расхождение предсказанного и реального значений и есть изменившиеся участки.</li>
</ul>

<p>Регрессию будем строить при помощи нейронных сетей. Данные, предназначенные для анализа хранятся в проекте GRASS, используемые снимки - MODIS (используются два канала - (1) красный и (2) ближний инфракрасный). Рассматриваются две даты: 3 апреля 2000 года и 12 июля 2000 года и территория заповедника Черные Земли.</p>

<p class="ill">
    <a href="/images/grass-neuro-r-01b.png"><img src="/images/grass-neuro-r-01.png" alt="Композитное RGB изображение 1-2-1, 3 апреля 2000, данные MODIS" width="600" height="450" border="0"></a>
    <span>Композитное RGB изображение 1-2-1, 3 апреля 2000, данные MODIS</span></p>

<p class="ill">
    <a href="/images/grass-neuro-r-02b.png"><img src="/images/grass-neuro-r-02.png" alt="Композитное RGB изображение 1-2-1, 12 июля 2000, данные MODIS" width="600" height="450" border="0"></a>
    <span>Композитное RGB изображение 1-2-1, 12 июля 2000, данные MODIS</span></p>

<p>Т.о. действовать будем следующим образом:</p>
<ol>
	<li>Предобработка данных: производится в GRASS.</li>
	<li>Построение нейронной сети: производится в R.</li>
	<li>Постобработка данных и анализ результатов: производится в GRASS.</li>
</ol>


<!-- Второй раздел -->
<h2><strong><a name="02" id="02"></a></strong>2. Реализация</h2>
<h3>Предобработка</h3>

<p>Будем строить многослойный перцептрон, который берет на входе значения первого и второго каналов снимков от 3-го апреля, а на выходе возвращает предполагаемые значения первого и второго каналов для снимков от 12-го июля. Функцию активации нейронов возьмем сигмоидального типа:</p>
<p style="text-align: center;">f(u) = 1/(1+ exp(-u)).</p>

<p>Перед построением сети необходимо предварительно пронормировать данные. Выходные значения должны быть нормированы к диапазону изменения функции активации (0, 1), входные же значения нормировать хотя и не обязательно, но, тем не менее, очень желательно.</p>

<p>Конкретный вид нормирующей функции становится ясен после анализа гистограммы распределения входных и выходных данных. В качестве примера возьмем данные по второму каналу каждого снимка:</p>

<p class="ill">    <img src="/images/grass-neuro-r-03.png" alt="Композитное RGB изображение 1-2-1, 12 июля 2000, данные MODIS" width="300" height="225" border="0">
    <span>Гистограмма для второго канала (3 апреля)</span></p>

<p class="ill">    <img src="/images/grass-neuro-r-04.png" alt="Композитное RGB изображение 1-2-1, 12 июля 2000, данные MODIS" width="300" height="225" border="0">
    <span>Гистограмма для второго канала (12 июля)</span></p>

<p>Как видим, первая гистограмма близка к нормальной, поэтому воспользуемся линейной нормировкой с использованием статистических характеристик. Более конкретно, пронормируем данные соответсвующего снимка по формуле:</p>

<p style="text-align: center;">X = (x - m)/s</p>

<p>Здесь X - нормированное значение, x - исходное значение, m - среднее значение, s - стандартное отклонение.</p>

<p>Со вторым снимком дело обстоит немного сложнее: на гистограмме явно видны длинные хвосты слева и справа, соответственно, линейное нормирование к диапазону (0, 1) приведет к тому, что почти все данные будут сгруппированы в небольшом интервале. Чтобы избежать этого воспользуемся нормировкой при помощи функции активации:</p>

<p style="text-align: center;">X = f[(x - m)/s]</p>

<p>Здесь X - нормированное значение, x - исходное значение, m - среднее значение, s - стандартное отклонение, f - функция активации нейронов.</p>

<p>С первым каналом дело обстоит аналогично.</p>

<p>Реализация нормирования в GRASS GIS:</p>

<ul>
	<li>Посмотрим статистику по первому каналу для снимка от 3-го апреля:
<pre>r.univar A2000.092.1 -g

n=699312
null_cells=748326
cells=1447638
min=582
max=4169
range=3587
mean=1505.60636025122
mean_of_abs=1505.60636025122
stddev=347.104721534699
variance=120481.687711681
coeff_var=23.0541481956002
sum=1052888595</pre>
</li>
	<li>Пронормируем:
<pre>eval `r.univar A2000.092.1 -g`
r.mapcalc "norm_A2000.092.1 = (A2000.092.1 - $mean)/$stddev"</pre>
</li>
	<li> Посмотрим на результат:
<pre>r.info norm_A2000.092.1
 +----------------------------------------------------------------------------+
 | Layer:    norm_A2000.092.1               Date: Thu Jan  6 17:22:46 2011    |
 | Mapset:   PERMANENT                      Login of Creator: dima            |
 | Location: fires                                                            |
 | DataBase: /home/dima/laboro/GRASSDATA                                      |
 | Title:     ( norm_A2000.092.1 )                                            |
 | Timestamp: none                                                            |
 |----------------------------------------------------------------------------|
 |                                                                            |
 |   Type of Map:  raster               Number of Categories: 255             |
 |   Data Type:    DCELL                                                      |
 |   Rows:         1333                                                       |
 |   Columns:      1086                                                       |
 |   Total Cells:  1447638                                                    |
 |        Projection: Albers Equal Area                                       |
 |            N: 4755751.76759771    S: 4422409.14242904   Res: 250.06948625  |
 |            E: 8747582.56252927    W: 8476175.04184751   Res: 249.91484409  |
 |   Range of data:    min = -2.660887  max = 7.673170                        |
 |                                                                            |
 |   Data Description:                                                        |
 |    generated by r.mapcalc                                                  |
 |                                                                            |
 |   Comments:                                                                |
 |    (A2000.092.1 - 1505.6064) / 347.10472                                   |
 |                                                                            |
 +----------------------------------------------------------------------------+</pre>
</li>
</ul>

<p>Аналогично поступим с остальными снимками:</p>


<pre>eval `r.univar A2000.092.2 -g`
r.mapcalc "norm_A2000.092.2 = (A2000.092.2 - $mean)/$stddev"

eval `r.univar A2000.192.1 -g`
r.mapcalc "norm_A2000.192.1 = 1/(1 + exp(- (A2000.192.1 - $mean)/$stddev))"

eval `r.univar A2000.192.2 -g`
r.mapcalc "norm_A2000.192.2 = 1/(1 + exp(- (A2000.192.2 - $mean)/$stddev))"</pre>

<p>В качестве примера ниже приводится гистограмма для нормированного второго канала (12-е июля):</p>

<p class="ill">    <img src="/images/grass-neuro-r-05.png" alt="Гистограмма нормированного снимка" width="300" height="225" border="0">
    <span>Гистограмма нормированного снимка</span></p>

<h3>Построение нейронной сети</h3>

<p>Загружаем R из-под GRASS GIS и считываем данные (дальнейшие команды вводятся в сеансе R):</p>

<pre>library(spgrass6)
in1 = readRAST6('norm_A2000.092.1')
in2 = readRAST6('norm_A2000.092.2')
out1 = readRAST6('norm_A2000.192.1')
out2 = readRAST6('norm_A2000.192.2')</pre>


<p>Создадим data.frame, содержащий считанные данные, и почистим его от пустых значений:</p>

<pre>d = data.frame(in1 = as.vector(as.matrix(in1)), in2 = as.vector(as.matrix(in2)), out1 = as.vector(as.matrix(out1)), out2 = as.vector(as.matrix(out2)))
d=d[!is.na(d$in1),]
d=d[!is.na(d$out1),]</pre>


<p>Разобъем данные на обучающее и валидационное множества, в обучающее множество поместим приблизительно 2/3 примеров:</p>

<pre>len = length(d[,1])
val.ind = sample(1:len, size = len/3)
val = d[val.ind,]
train_data = d[-val.ind,]</pre>

<p>Подгрузим <a href="http://rwiki.sciviews.org/doku.php?id=packages:cran:amore">AMORE</a> - пакет для работы с нейронными сетями. (В R есть несколько пакетов, позволяющих создавать многослойные сети, пакет AMORE был выбран, в первую очередь, из-за скорости работы).</p>


<pre>library(AMORE)</pre>

<p>Создадим нейронную сеть. Поскольку данных для обучения имеется достаточное количество (около 700 тыс. пикселей), то и количество нейронов можно взять относительно большим. Для начала создадим сеть достаточно больших размеров - с двумя скрытыми слоями по 20 и 10 нейронов в каждом(2-20-10-2); функцию активации для всех нейронов выберем сигмоидальную (логистическую):</p>


<pre>net = newff(n.neurons=c(2,20,10,2), learning.rate.global=0.1, momentum.global=0.01,error.criterium="LMS", hidden.layer="sigmoid", output.layer="sigmoid", method="ADAPTgdwm")</pre>

<p>Обучим сеть в течении 500 итераций, для этого передадим процедуре обучающее и валидационное множества. На обучающем множестве будут настраиваться веса сети, валидационное использоваться для раннего останова. Полученную сеть назовем net1</p>

<pre>result = train(net, P=train_data[,1:2], T=train_data[,3:4], Pval=val[,1:2], Tval=val[,3:4], error.criterium="LMS", report=TRUE, show.step=1, n.shows=500)
net1 = result$net</pre>


<p>В ходе экспериментов наиболее удачной сетью оказалась сеть с одним скрытым слоем и пятью нейронами в нем. В результате обучения этой сети была достигнута ошибка на обучающем множестве: 0.0188, на валидационном: 0.0190.</p>

<p>После обучения сети произведем расчеты, подавая в обученную сеть данные первого снимка. Для этого предварительно входные данные поместим в ненужную уже переменную d, затем в переменную y поместим результаты работы сети:
</p>


<pre>d = data.frame(in1 = as.vector(as.matrix(in1)), in2 = as.vector(as.matrix(in2)) )
y = sim(net1, d)</pre>


<p>И, наконец, последний этап,  который нужно проделать в R - экспорт результатов обратно в GRASS:</p>
<pre>r1 = out1
r1$norm_A2000.192.1 = y[,1]
writeRAST6(r1, 'net.1')

r2 = out2
r2$norm_A2000.192.2 = y[,2]
writeRAST6(r2, 'net.2')</pre>


<h3>Анализ результатов</h3>

<p>После экспорта полученных растров в GRASS выходим из R. Прежде, чем сравнивать созданные нейронной сетью растры с реальными снимками, их нужно денормировать. Понятно, что денормировать нужно используя те же параметры среднего и стандартного отклонения, которые использовались при нормировании:<p>
<p style="text-align: center;">x = m - s*log(1/X - 1)</p>

<p>Для этого:</p>

<pre>eval `r.univar A2000.192.2 -g`
r.mapcalc "net_A2000.192.2 = $mean - $stddev * log(1/net.2 - 1)"

eval `r.univar A2000.192.1 -g`
r.mapcalc "net_A2000.192.1 = $mean - $stddev * log(1/net.1 - 1)"</pre>


<p>В итоге получаем два растра net_A2000.192.1 и net_A2000.192.2, в которых содержатся значения для первого и второго канала соответственно, предсказанные нейронной сетью.  Вместо того, чтобы сравнивать непосредственные значения полученных растров и снимков, будет удобно найти разности между предсказанным значением и реальным снимком:</p>

<pre>r.mapcalc "razn2 = net_A2000.192.2 - A2000.192.2"
r.mapcalc "razn1 = net_A2000.192.1 - A2000.192.1"</pre>

<p>
Покрасим разности для удобства восприятия, используя их статистические характеристики:</p>
<pre>r.colors.stddev razn2
r.colors.stddev razn1</pre>

<p>Фрагменты полученных результатов приводятся на рисунках ниже. Сначала рассмотрим исходные снимки (северо-восточный фрагмент участка):</p>

<p class="ill">    <a href="/images/grass-neuro-r-06b.png"><img src="/images/grass-neuro-r-06.png" alt="Долина Волги, 3-е апреля (rgb: 1-2-1)" width="600" height="369" border="0"></a>
    <span>Долина Волги, 3-е апреля (rgb: 1-2-1)</span></p>

<p class="ill">    <a href="/images/grass-neuro-r-07b.png"><img src="/images/grass-neuro-r-07.png" alt="Долина Волги, 12-е июля (rgb: 1-2-1)" width="600" height="369" border="0"></a>
    <span>Долина Волги, 12-е июля (rgb: 1-2-1)</span></p>

<p>На снимках хорошо видно изменение растительности в долине Волги. Кроме того на позднем снимке заметна небольшая облачность. Степень различия предсказанных и реальных значений видна на растрах razn1 и razn2. Яркие участки соответствуют большим по модулю значениям разности, бледные участки - небольшим:</p>

<p class="ill">    <a href="/images/grass-neuro-r-08b.png"><img src="/images/grass-neuro-r-08.png" alt="Разность (razn1" width="600" height="369" border="0"></a>
    <span>Разность (razn1</span></p>

<p class="ill">    <a href="/images/grass-neuro-r-09b.png"><img src="/images/grass-neuro-r-09.png" alt="Разность (razn2)" width="600" height="369" border="0"></a>
    <span>Разность (razn2)</span></p>


<p>Для удобства восприятия можно объединить две разности в один растр. Первое, что приходит в голову - перемножить их, тогда большие отклонения разностей, присутствующие на обоих растрах увеличатся еще больше, а малые - уменьшатся:</p>

<pre>r.mapcalc "razn = razn1 * razn2"
r.colors.stddev razn</pre>

<p class="ill"><a href="/images/grass-neuro-r-10b.png"><img src="/images/grass-neuro-r-10.png" alt="Комбинация razn1 и razn2" width="600" height="369" border="0"></a><span>Комбинация razn1 и razn2</span></p>

<p>На полученном таким образом объединенном снимке более четко видны границы изменений: растительность в долине Волги, а также облака, появившиеся на втором снимке.<p>
<!-- обсуждение на форуме, цифра изменяется при публикации статьи -->   
<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=7175"--></span></p>
<!-- ссылки -->
<div class="links">
	<h2>Ссылки по теме</h2>
		<ul>
			<li><a href="grass-r.html">Анализ данных с использованием GRASS GIS и R</a></li>
			</ul>
</div>


<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 09.01.2011
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=6597" target="_blank">Дмитрий Колесов</a>, <a href="/forum/memberlist.php?mode=viewprofile&u=2" target="_blank">Максим Дубинин</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
