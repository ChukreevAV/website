<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Изменение кодировки DBF файла</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Вопросы и ответы</a></li>
</ul>
<!--Contents start-->
<h1>Изменение кодировки DBF файла</h1>
<p class="ann">Описание использования библиотеки dbfpy для изменения кодировки данных и скрипт </p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=5425"--></span></p>

<p>Неотъемлимой частью данных в формате  shape является атрибутивная таблица в формате DBF. Атрибутивные данные могут храниться в разных кодировках, часто встречаются такие кодировки как Windows-1251 (CP1251) и UTF8, KOI8-R. Некоторое, особенно  относительно давно появившиеся ГИС, такие как Arcview GIS 3.x, некоторые версии Mapinfo, не умеют работать с более новой кодировкой UTF8. Соответственно, часто встречается задача перевода DBF из одной кодировки в другую. </p>
<p>Для преобразования dbf из одной кодировки в другую можно использовать скрипт на языке Python (<a href="/programs/python/dbf-encode.zip">скачать</a> скрипт). Эта статья описывает подготовку к работе, идею скрипта и как с ним работать. </p>
<h2>Подготовка к работе </h2>
<p>Для работы скрипта необходимо иметь Python 2.5/2.6 и один раз скачать и установить библиотеку <a href="http://dbfpy.sourceforge.net/" target="_blank" class="external">dbf2py</a>. После загрузки библиотеки нужно выполнить: </p>
<pre>python setup.py install</pre>
<p>Правильность установки библиотеки можно проверить запустив Python и выполнив:</p>
<pre>from dbfpy import dbf</pre>
<p>Если все установлено нормально, ошибок эта команда выдать не должна.</p>
<h2>Идея</h2>
<p>В процессе работы, наш скрипт должен построчно проверять тип поля в исходном файле DBF и, если он строковый, т.е. есть вероятность того, что данные не в той кодировке, что нужно, осуществлять преобразование. Упрощенная версия скрипта на языке Python для перевода данных из кодировки в кодироввку выглядит следующим образом:</p>
<pre>#!/usr/bin/python
#--*-- encoding: utf-8 --*--

import sys
from dbfpy import dbf
from types import *

db = dbf.Dbf(sys.argv[1])
newDB=dbf.Dbf(sys.argv[2], new=True)

for f in db.header.fields:
   newDB.addField(f)

for rec in db:
   r=newDB.newRecord()
   newData=[]
   for f in rec.fieldData:
      if type(f)==StringType:
         f=unicode(f,'utf-8')
         f=f.encode('windows-1251')
      newData.append(f)
   r.fieldData=newData
   r.store()

db.close()
newDB.close()</pre>
<h2>Использование</h2>
<p>Утилита вызывается из командной строки и принимает несколько  параметров:</p>
<pre>python dbf-encode.py -f encin -t encout -n input output</pre>
<p>&nbsp;</p>
<ul>
  <li>input - имя исходного файла dbf, который требуется преобразовать, обязателен. </li>
  <li>output - имя конечного файла dbf, куда будет записан результат, обязателен. </li>
  <li>-f (--from-code)  - кодировка исходного DBF файла, не обязателен, по умолчанию UTF8. </li>
  <li>-f (--to-code) - кодировка выходного DBF файла, не обязателен, по умолчанию CP1251.</li>
  <li>-n (--no-subs) - переключатель, если установлен, то неизвестные символы пропускаются, если не установлен - заменяются на &quot;?&quot;</li>
  <li>-h (--help) - справка</li>
  <li>-v (--version) - версия программы </li>
</ul>
<p>Пример использования:</p>
<p>Конвертировать  adygeya-admin-a.dbf в adygeya-admin-a2.dbf из кодировки UTF8 в кодировку CP1251.</p>
<pre>python dbf-encode.py -f UTF8 -t CP1251 adygeya-admin-a.dbf adygeya-admin-a2.dbf</pre>
<p>или упрощенная запись параметров командной строки (эти кодировки и так являются кодировками на входе и выходе по умолчанию):</p>
<pre>python dbf-encode.py adygeya-admin-a.dbf adygeya-admin-a2.dbf </pre>
<h2>Ошибки конвертации</h2>
<p>Если конвертер сталкивается с символом, который не может перекодировать, он по-умолчанию заменяет его на вопросительный знак, если к строке запуска добавлен --nosubs (-n), то символ пропускается. </p>
<p>Если возникает другая ошибка при конвертации, конвертер выводит содержание записи на которой возникла ошибка в консоль и прекращает работу. Конечный файл создается неполным и для подмены оригинального в shape-файле непригоден.</p>
<p>Ошибка invalid syntax может быть связана с неправильным запуском скрипта, под Windows запуск нужно осуществлять из командного процессора (Пуск\Запуск\cmd) после чего вводить команду указанную выше. </p>
<p><a href="/programs/python/dbf-encode.zip">Скачать</a> полную версию dbf-encode.py</p>
<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=5425"--></span></p>
<!-- ссылки -->
<div class="links">
	<h2>Ссылки по теме</h2>
		<ul>
			<li><a href="/qa/dbf2csv.html">Конвертация DBF в CSV </a></li>
			</ul>
</div>
<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 16.05.2010
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=2" target="_blank">Максим Дубинин</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
