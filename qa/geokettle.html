<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: GeoKettle. Первые шаги</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Вопросы и ответы</a></li>
</ul>

<h1>GeoKettle. Первые шаги</h1>

<!--Contents start-->
<p class="ann">Первое знакомство с программой GeoKettle. Простейшие преобразования и примеры несложных схем.</p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8248"--></span></p>

<p><strong>Оглавление</strong></p>
<ol>
	<li><a href="#01">Введение</a></li>
	<li><a href="#02">Установка программы</a></li>
	<li><a href="#03">Простой пример</a></li>
	<li><a href="#04">Обработка множества файлов</a></li>
	<li><a href="#05">Заключение</a></li>
	<li><a href="#06">Приложения</a></li>
	<li><a href="#07">Ссылки</a></li>
</ol>

<!-- Первый раздел -->
<h2><a name="01" id="01"></a>Введение</h2>

	<P><I><A HREF="http://www.geokettle.org/">www.geokettle.org</A><BR>Лицензия: GPL v2</I></P>

	<P >Программа GeoKettle в терминах бизнес-анализа
	(business intelligence) относится к инструментам ETL (Extract,
	Transform, Load) и, соответственно, предназначена для загрузки
	данных из разрозненных источников в единый банк данных.</P>
	<P >Применим ее возможности для повседневной работы с
	данными ГИС. Программа позволяет загружать данные самых различных
	форматов, преобразовывать их и сохранять результат обратно в файлы и
	базы данных. Поскольку GeoKettle основана на ETL общего назначения
	Kettle [<A HREF="#snote01">1</A>],
	то помимо специфичных функций ГИС (см. ниже) доступны и базовые
	операции - алгебраические функции, фильтры (в том числе по
	RegExp), обработка текстовых строк, пользовательские скрипты на
	языках JavaScript и SQL, и т.п.</P>
	<P >Как правило это не разовые операции, а рутинные
	процессы. Например, вы регулярно получаете файлы от смежных
	организаций, загружаете материалы с публичных интернет-ресурсов,
	производите агрегацию данных двух независимых департаментов и т.п.
	В таком случае составляется цепочка действий, сохраняется и
	вызывается в нужный момент. Думаю, многие специалисты ГИС имеют в
	своем запасе несколько командных файлов (скриптов), для
	преобразования форматов, проекций, объединения файлов. GeoKettle
	выполняет тоже самое, но в графическом виде.</P>
	<P >В статье не описываются специфичные для бизнес-анализа
	задачи (составление кубов Spatial OLAP), а затрагиваются только
	возможности ГИС.</P>
	<P >Итак, программа умеет работать с различными форматами
	данных:</P>
	<UL>
		<LI><P>Базы данных: PostGIS, Oracle Spatial, MySQL, Microsoft SQL Server и т.д.;</P>
		<LI><P>Файлы ESRI Shapefile, GML, KML, форматы GDAL/OGR (только	векторные);</P>
		<LI><P>Сервисы OGC: SOS, CSW.</P>
	</UL>
	<P >Выполняет преобразования:</P>
	<UL>
		<LI><P>Построение буферов и центроидов, вычисление длин и площадей;</P>
		<LI><P>Пространственная алгебра - объединение, пересечение и т.п.;</P>
		<LI><P>Преобразование линий в полигоны и обратно, упрощение и сглаживание;</P>
		<LI><P>Триангуляция Делоне.</P>
	</UL>
	<P >Существует проект BeETLe [<A HREF="#note02">2</A>],
	ставящий своей целью интеграцию в GeoKettle библиотеки SEXTANTE [<A HREF="#note03">3</A>]
	и возможность работы с растровыми форматами. Приложение было
	представлено на FOSS4G 2010, но состояние развития проекта
	неизвестно.</P>

<!-- Второй раздел -->
<h2><a name="02" id="02"></a>Установка программы</h2>

	<P >Программа работает в Windows, Linux, MacOSX
	и др. Инсталлятор единый - geokettle-XXX-installer.jar
	[<A HREF="#note04">4</A>]. В системе уже должен быть установлен Java JRE.
	При работе в Linux файл требуется сделать запускаемым (chmod -x). Во
	время установки создается ярлык на рабочем столе, но, если этого не
	произошло, то программа запускается файлом geokettle.bat
	(geokettle.sh).</P>

<!-- Третий раздел -->
<h2><a name="03" id="03"></a>Простой пример</h2>

	<P >В качестве примера рассмотрим загрузку в базу данных
	PostGIS слоя границ субъектов РФ [<A HREF="#note05">5</A>]:
	файл в формате ESRI Shapefile, кодировка windows-1251, проекция
	Albers-Siberia на эллипсоиде WGS84. Требуемая проекция - epsg:4326 (WGS84).</P>
	<P >Запустим программу и выберем вариант &quot;No
	repository&quot;. (Репозиторий используется для хранения документов
	и настроек в базе данных и для совместной работы.)</P>
	
	<P ALIGN=CENTER><IMG SRC="/images/geokettle-1.jpg" width="712" height="511"></P>
	
	<P >В открывшемся главном окне программы нужно создать документ. Возможны два типа -
	<I>Transformation</I> (преобразование) и <I>Job</I> (задача). Первый
	предназначен для работы с данными, а второй манипулирует файлами,
	запускает внешние скрипты, отправляет уведомления по почте.
	Transformation работает внутри Job.</P>
	<P >Для одного файла только Transformation. Создадим новый
	документ (File|New|Transformation). Из списка в левой части
	перенесем блоки:</P>
	<UL>
		<LI><P>Input|Shapefile File Input</P>
		<LI><P>Transform|SRS Transformation</P>
		<LI><P>Output|Table output</P>
	</UL>
	<P >Обратите внимание, что в разделе Input доступны еще
	два подходящих варианта: ESRI Shapefile Reader и OGR
	File Input. Второй вариант не подходит потому, что не позволяет
	задать кодировку текстовых полей, а первый - просто не работает.</P>
	<P >Соединим все три блока последовательно. Операция
	выполняется средней кнопкой мышки (колесо прокрутки) - нажать
	на первом блоке и протащить на второй.</P>
	
	<P ALIGN=CENTER><IMG SRC="/images/geokettle-2.png" width="288" height="64"></P>
	
	<P >Перейдем к настройке отдельных блоков. Двойным щелчок
	открываем блок <B>Shapefile	File Input</B>, задаем имя файла и кодировку.</P>
	
	<P ALIGN=CENTER><IMG SRC="/images/geokettle-3.png" width="411" height="268"></P>
	
	<P>По кнопке Preview можно посмотреть содержимое файла, его
	графическое представление и убедиться что кодировка выбрана
	правильно.</P>
	
	<P ALIGN=CENTER><IMG SRC="/images/geokettle-4bis.png" width="514" height="375"> <IMG SRC="/images/geokettle-4tris.png" width="340" height="375"></P>

	<P >В блоке <B>SRS Transformation</B> укажем поле,
	содержащее геометрию объектов (the_geom), поставим галочку в поле
	<I>&quot;Auto-detect spatial reference system from source&quot;</I>
	для автоматического определения исходной проекции и в списке в
	правой части выберем требуемую проекцию (WGS 84).</P>
	<P >Блок <B>Table output</B> предназначен для экспорта результата в базу данных. В
	графе <I>Connection</I> по кнопке <I>New...</I> создадим подключение к PostGIS.
	Выберем тип БД - PostgreSQL и укажем параметры подключения.

	<P ALIGN=CENTER><img src="/images/geokettle-5.jpg" width="598" height="507"></P>

	Кнопка <I>Test</I> служит для проверки доступа к БД, ответ должен быть &quot;[Test]	is OK&quot;. Создание
	подключения закончено, возвращаемся в блок Table output. Осталось указать только название таблицы (<I>Target
	table</I>) - пусть будет &quot;regions&quot;.</P>
	<P >Попробуем запустить	процесс. Для этого сохраняем документ (File|Save),
	выбираем в меню	Transformation|Run, в открывшемся окне нажимаем кнопку <I>Launch</I>.
	Процесс завершится ошибкой в блоке <b>Table	output</b> (красный значок на схеме).</P>

	<P ALIGN=CENTER><img src="/images/geokettle-2bis.png" width="341" height="66"></P>

	<P >Ошибка возникла потому, что в базе данных отсутствует
	таблица &quot;regions&quot; и ее требуется предварительно создать.
	Для этого опять откроем блок <b>Table output</b> и нажмем кнопку <i>SQL</i>.
	Предложенный sql-запрос можно сразу запустить (кнопка <i>Execute</i>)
	или изменить его и добавить в код создания таблицы дополнительные
	поля. Например, введем колонку первичного ключа (id).</P>

	<P ALIGN=CENTER><IMG SRC="/images/geokettle-6.png" width="408" height="307"></P>

	<P>Если таблица с указанным именем в БД уже
	существует, то программа может предложить добавить поля (ALTER
	TABLE... ADD COLUMN) или изменить тип данных.
	</P>
	<P>Повторим процедуру запуска трансформации, которая теперь пройдет без
	ошибок, и убедимся что в БД создана новая таблица, данные загружены
	и внесена запись в системную таблицу &quot;geometry_columns&quot;.</P>

<!-- Четвертый раздел -->
<h2><a name="04" id="04"></a>Обработка множества файлов</h2>

	<P >Поставим задачу преобразования набора файлов для
	MapInfo из проекта GeoSample [<A HREF="#note06">6</A>]
	в формат ESRI Shapefile. Для этого потребуется составить список
	файлов с раширением &quot;*.tab&quot; в каталоге и потом для каждого
	элемента списка выполнить процедуру считывания (ввода) и сохранения
	(вывода).</P>
	<P >К статье приложен готовый проект, рекомендуется
	обращаться к нему для выяснения деталей настройки отдельных блоков.</P>

	<H3>1. Список файлов</H3>

		<P >Создадим новый документ типа <I>Transformation</I> и
		составим цепочку действий.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-7.png" width="376" height="66"></P>

		<P >Первый блок <b>Get File Names</b> формирует
		список файлов в каталоге. В настройках блока можно указать как
		абсолютный путь, так и относительно расположения скрипта GeoKettle:</P>
		<PRE ALIGN=CENTER>${Internal.Transformation.Filename.Directory}/tab</PRE>
		<P >Список доступных переменных можно посмотреть нажав сочетание клавиш Ctrl+Пробел.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-8.png" width="556" height="394"></P>

		<P >Результатом работы <b>Get File Names</b> будет список,
		содержащий полное и сокращенное имена файлов, размер файла, атрибуты &quot;скрытый&quot; и &quot;защита от записи&quot;
		(read only) и др. Поэтому следующие блоки выбирают нужное поле
		(filename) в двух экземплярах и заменяют в одном из них &quot;tab&quot;
		на &quot;shp&quot;.</P>
		<P >Последний блок завершает процедуру и передает
		результат работы на следующий шаг - список, каждая строка которого содержит поля filenameTAB и
		filenameSHP.</P>

	<H3>2. Обработка отдельного файла</H3>

		<P >Следующим этапом идет преобразование формата MapInfo в ESRI Shapefile. Оно оформляется отдельно
		и главной задачей здесь стоит использование не абсолютных путей к файлам, а	генерируемых на предыдущем шаге.</P>

		<P ALIGN=CENTER><img src="/images/geokettle-9.png" width="314" height="66"></P>

		<P >Для этого в графе <i>&quot;File name&quot;</i> в блоках <b>OGR file input</b> и
		<b>OGR file output</b> указываются переменные. <b>SRS Transformation</b>
		использован только как пример обработки файла и может быть заменен
		на любой другой или исключен из схемы.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-10.png" width="280" height="161"></P>

	<H3>3. Создание переменных</H3>

		<P >Переменные filenameTAB и filenameSHP формируются из
		полей списка файлов, полученного на первом шаге. Для этого служит
		блок <b>Job|Set Variables</b>. Особенность его работы заключается в том,
		что созданные переменные будут доступны только на следующем этапе и
		их нельзя использовать в том же документе <I>Tranformation</I>. Это
		ограничение происходит из условия <B>определенности</B> всех данных
		на момент запуска скрипта и используется для распараллеливания
		процесса.</P>
		<P >Поэтому создается отдельный, третий по счету, документ
		типа <I>Tranformation</I>, который должен будет
		отработать до этапа &quot;Обработка отдельного файла&quot;.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-11.png" width="226" height="69"></P>

		<P>Примечание. В версии
		2.0 появилась функция <i>&quot;Filename is defined in a field&quot;</i>,
		которая позволила бы объединить этапы 2 и 3 в один. Но на текущий
		момент она реализована не во всех блоках ввода. Например, смотрите
		<b>Shapefile File Input</b>.</P>

	<H3>4. Конвейер</H3>

		<P >Осталось собрать все трансформации в единую схему.
		Создадим документ типа <I>Job</I>, добавим
		трансформацию &quot;Список файлов&quot; (filelist) и задачу &quot;every
		file job&quot;, в параметрах которой укажем <i>&quot;Execute for every
		input row&quot;</i>. Это означает, что задача &quot;every file job&quot;
		будет вызвана столько раз, сколько строк сформировано в списке
		файлов.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-12.png" width="261" height="62"></P>

		<P >Второй документ (every file job) типа <I>Job</I> содержит трансформации этапов 2 и 3 в упомянутом порядке.</P>

		<P ALIGN=CENTER><IMG SRC="/images/geokettle-13.png" width="252" height="66"></P>

		<P >Запуск всей процедуры обработки файлов выполняется из первого документа (файл root.kjb в приложении).</P>

<!-- Пятый раздел -->
<h2><a name="05" id="05"></a>Заключение</h2>

	<P >Программа GeoKettle обладает большими возможностями и высокой производительностью.
	Создание простых трансформаций является очень простой и наглядной операцией. Но работа со сложными схемами
	с вложенными задачами сильно запутана и представляет сложности при отладке с появлением неявных и плохо
	задокументированных ошибок. Тем не менее вторая версия программы идет по пути облегчения работы и добавляет
	более простые механизмы.</P>

	<P >В комплект дистрибутива включены хорошие примеры работы с геометрией (используется диалект JavaScript для библиотеки JTS).
	Расположены в каталоге установленной программы "samples\transformations\geokettle\".</P>
	<P >Аналоги:</P>
	<UL>
		<LI><A HREF="http://www.talendforge.org/">Talend Open Studio</A> (<A HREF="http://www.talendforge.org/wiki/doku.php?id=sdi:MainPage">Spatial module</A>), лицензия GPL v2.
		<LI><A HREF="http://safe.com/">FME</A> (Safe Software), коммерческое приложение.
		<LI>ArcGIS ModelBuilder [<A HREF="#note07">7</A>], коммерческое приложение.
		<LI><A HREF="http://en.wikipedia.org/wiki/Spatial_ETL#Spatial_ETL_tools">Список программ в Wikipedia</A>
	</UL>
	
<!-- Шестой раздел -->
<h2><a name="06" id="06"></a>Приложения</h2>
	<ul>
		<li><a href="/other/geokettle.pdf">Версия в формате PDF</a></li>
		<li><a href="/other/geokettle-sample.zip">Готовый проект</a> для самостоятельной работы </li>
	</ul>
	
<!-- Седьмой раздел -->
<h2><a name="07" id="07"></a>Ссылки</h2>
<ol>
	<li><a name="note01"></a>Программа Kettle из пакета бизнес-анализа Pentaho Data Integration // <a href="http://kettle.pentaho.com/">http://kettle.pentaho.com/</a></li>
	<li><a name="note02"></a>BeETLe Project // <a href="http://beetle-project.blogspot.com/">http://beetle-project.blogspot.com/</a></li>
	<li><a name="note03"></a>Sextante project // <a href="http://www.sextantegis.com/">http://www.sextantegis.com/</a></li>
	<li><a name="note04"></a>Версия программы на момент написания статьи — <a href="http://sourceforge.net/projects/geokettle/files/geokettle-2.x/2.0-RC1/">2.0-RC1</a></li>
	<li><a name="note05"></a>Дубинин М.Ю., Генерализованные слои границ субъектов РФ // <a href="http://gis-lab.info/qa/rusbounds-rosreestr-gen.html">http://gis-lab.info/qa/rusbounds-rosreestr-gen.html</a></li>
	<li><a name="note06"></a>Geosample: Открытый набор геоданных для различного ПО ГИС // <a href="http://gis-lab.info/qa/geosample.html#get">http://gis-lab.info/qa/geosample.html</a></li>
	<li><a name="note07"></a>Дубинин М.Ю., Использование скриптов-посредников на Python в моделях ArcGIS // <a href="http://gis-lab.info/qa/mb-python.html">http://gis-lab.info/qa/mb-python.html</a></li>
</ol>
<!--Contents end-->

<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8248"--></span></p>
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 29.07.2011
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=6850" target="_blank">Mavka</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
