<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Классификация растровых данных при помощи DTclassifier для QGIS</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Вопросы и ответы</a></li>
</ul>
<!--Contents start-->
<h1>Классификация растровых данных  при помощи DTclassifier для QGIS</h1>
<p class="ann">Описание и пример использования нового инструмента
 классификации растров.</p>
<p class="discuss discuss_top"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8172"--></span></p>

<p>Тематическая классификация растров с обучением является довольно распространенной
задачей. Типичная классификация используе на входе набор растров, чаще всего данных дистанционного зондирования и набор
тренировочных территорий, определяющих искомые и все остальные (фоновые) объекты. После
сбора этой информации методики собственно построения модели классификации
могут быть разными, параметрическими и непараметрическими. Первые подразумевают
наличие некоторого статистического распределения в тренировочных данных
(например, нормального), последние таких допущений не делают и являются
поэтому более гибкими и менее ограниченными. На сайте уже есть несколько
статей, описывающих непараметрическую классификацию растровых данных при
помощи <a href="/qa/classify-trees-r.html">деревьев классификации в R</a> и
<a href="/qa/imagesvm.html">метода опорных векторов в imageSVM</a>. Кроме того,
помимо проприетарных решений, для решения этой задачи существуют и другие
программные продукты с открытым исходным кодом, например, инструменты
классификации есть в OTB и GRASS.</p>
<p>В большинстве случаев подобные решения являются самостоятельными приложениями
и не интегрируются с ПО ГИС, также отсутствуют удобные инструменты
подготовки и редактирования тренировочных наборов данных, что усложняет
процесс их подготовки.</p>
<p>DTclassifier (Decision Tree classifier) является расширением свободной
ГИС QGIS, которое позволяет пройти все этапы  классификации
данных дистанционного зондирования не покидая ГИС. Расширение использует алгоритмы библиотеки
компьютерного зрения <a href="http://opencv.willowgarage.com/" target="_blank" class="external">OpenCV</a>,
а именно классификацию при помощи <a href="http://www.basegroup.ru/library/analysis/tree/description/" target="_blank" class="external">деревьев решений</a>.</p>
<p>Разработка расширения выполнена NextGIS в рамках проекта по мониторингу
лесов  сертифицированных FSC (Forest Stewardship Council).</p>

<div style="text-align:center;margin:10px 0;"><a href="http://nextgis.ru" target="_blank"><img height="33" width="100" alt="Комания NextGIS: Создание открытого ПО ГИС и реализация проектов" src="http://nextgis.ru/img/nextgis.png" style="margin: 0pt 7px 0pt 0pt; vertical-align: middle;"></a><strong style="font: bold 11px Arial;">Создание открытого ПО ГИС и реализация проектов</strong></div>

<p><strong>Оглавление</strong></p>
<ol>
  <li><a href="#01">Получение и установка</a></li>
  <li><a href="#02">Работа с расширением</a></li>
  <li><a href="#03">Пример: детектирование рубок</a></li>
  <li><a href="#04">Пример: анализ изменений</a></li>
  <li><a href="#05">Заключение</a></li>
  <li><a href="#06">Контакты</a></li>
</ol>

<h2><strong><a name="01" id="01"></a></strong>1. Получение и установка</h2>
<p>Расширение доступно как в виде исходного кода C++, так и в бинарной форме.</p>
<h3><strong>Бинарная сборка</strong>
</h3>
<p>Для работы с программой в ОС Windows понадобится:</p>
<ol>
  <li>загрузить и установить QGIS версии 1.8 или выше (<a href="/qa/qgis-osgeo4w.html">подробнее</a>)</li>
  <li><a href="http://svn.gis-lab.info/dtclassifier/trunk/bin/DTclassifier.7z">загрузить</a>
  архив с расширением и необходимыми библиотеками</li>
  <li>(опционально) проверить контрольную сумму при помощи md5sum или
  аналогичной программы:
  <pre>e4a260a271e7aa292f8d142eb481e6dc DTclassifier.7z</pre></li>
  <li>извлечь содержимое архива в каталог модулей QGIS (обычно это
  C:\OSGeo4W\apps\qgis-dev\plugins)</li>
</ol>
<p>Для работы с модулем в Linux необходимо:</p>
<ol>
  <li>установить QGIS версии 1.8 или выше. Если пакеты для вашего дистрибутива
  отсутствуют&nbsp;&mdash; необходимо скомпилировать QGIS из исходных кодов</li>
  <li>загрузить архив с расширением:<br/>
  32-разрядная версия (<a href="http://svn.gis-lab.info/dtclassifier/trunk/bin/dtclassifier-linux.tar.bz2">загрузить</a>).
  <strong>Примечание:</strong> модуль собран в 32-х разрядной Slackware 13.1
  с использованием OpenCV 2.2.0 и QGIS 1.8 (05d2cd9)<br/>
  64-разрядная версия (<a href="http://svn.gis-lab.info/dtclassifier/trunk/bin/dtclassifier-linux-x64.tar.bz2">загрузить</a>).
  <strong>Примечание:</strong> модуль собран в 64-х разрядной Ubuntu 11.04
  с использованием OpenCV 2.2.0 и QGIS 1.8<br/>
  </li>
  <li>(опционально) проверить контрольную сумму при помощи md5sum или
  аналогичной программы:
  <pre>49f3b8818283c9a864ffa6ec6e8fa03d  dtclassifer-linux.tar.bz2
439bf9fcc624e55baa1f8846e3d50c86  dtclassifier-linux-x64.tar.bz2  </pre></li>
  <li>извлечь содержимое архива в каталог модулей QGIS (обычно это
  /usr/lib/qgis/plugins)</li>
</ol>
<p>После установки нужно запустить QGIS и активировать расширение DTclassifier
в Менеджере модулей (&laquo;Модули&nbsp;&rarr; Управление модулями&raquo;).</p>
<h3><strong>Исходный код</strong>
</h3>
<p>Исходный код модуля (лицензия GNU GPL v2) можно получить, выполнив команду</p>
<pre>svn co http://svn.gis-lab.info/dtclassifier/trunk dtclassifier</pre>
<p>Также можно загрузить <a href="/data/samples/dtclassifier-demo.7z">архив</a>
c данными, использовавшимися при подготовке статьи.</p>

<h2><strong><a name="02" id="02"></a></strong>2. Работа с расширением</h2>
<p>После подключения и запуска расширения с помощью кнопки
<img src="/images/dtclassifier-01.png" alt="Кнопка расширения" width="22" height="22"></img>
появится главное окно.</p>

<p align="center"><img src="/images/dtclassifier-02.png" alt="Главное окно расширения" width="381" height="664"></img></p>

<h3>Выбор тренировочных данных </h3>
<p>При помощи выпадающих списков &laquo;Feature presence layer&raquo; и
&laquo;Feature absence layer&raquo; выбираюся тренировочные слои, отмечающие
области, где соответственно присутствует (presence) или отсутствует (absence)
интересующих нас признак. Эти слои создаются заблаговременно, перед началом
классификации. Создавать их можно прямо в QGIS по снимкам, используя всю
функциональность для работы с векторными и растровыми данными. Подробнее
о создании векторных данных можно прочитать в <a href="/docs/qgis">Руководстве
пользователя QGIS</a>.</p>
<p>Расширение работает во всеми видами геометрий: точками, линиями и полигонами.
Кнопка &laquo;+&raquo; рядом с каждым списком позволяет выбрать несколько
слоёв с тренировочными данными одновременно, причем геометрии этих слоев
могут быть различными.</p>

<p align="center"><img src="/images/dtclassifier-03.png" alt="Выбор тренировочных данных" width="262" height="300"></img></p>

<p>Выпадающий список работает только если слой с тренировочными данными&nbsp;&mdash;
один. При выборе нескольких слоёв выпадающий список блокируется и если
необходимо вернуться к работе с одним слоем нужно нажать кнопку
&laquo;+&raquo; еще раз.</p>
<p>Все исходные слои будут собраны в один точечный shape-файл. При этом
точечные слои будут записаны &laquo;как есть&raquo;, а линейные
и полигональные объекты будут сконвертированы в точечные так, чтобы
получить точки во всех пикселях, попадающих в полигон или на линию.</p>
<p>Например для полигонального слоя:</p>

<p align="center"><img src="/images/dtclassifier-04.png" alt="Результат конвертации полигона в точечный слой" width="339" height="403"></img></p>

<p>Для определения точек, попадающих на линию, используется следующий алгоритм.
Вокруг линии строится буферная зона шириной в 1/2 пикселя; в центре каждого
пикселя, попадающего или пересекающего буферную зону ставится точка, затем
отбираются точки, полностью попадающие в эту зону.</p>
<p>Пример для линейного слоя: </p>

<p align="center"><img src="/images/dtclassifier-05.png" alt="Результат конвертации линии в точечный слой" width="405" height="400"></img></p>

<p><strong>ВАЖНО!</strong> Правильные тренировочные данные&nbsp;&mdash;
залог успеха. Необходимо внимательно следить за выбираемыми слоями. Если
один и тот же слой отнести к обоим классам, результат классификации будет
некорректным.</p>

<h3>Выбор классифицируемых данных </h3>
<p>Поле &laquo;Raster(s) to classify&raquo; позволяет указать растр,
который необходимо классифицировать. Поддерживается выделение нескольких
растров с зажатым Shift или Ctrl, это может быть полезным при анализе
изменений, когда используются растры &laquo;до&raquo; и &laquo;после&raquo;.
Если выбрано несколько растров, то тренировочные данные будут выбираться
из каждого снимка.</p>
<p><strong>ВАЖНО!</strong> При выборе нескольких растров необходимо убедиться,
что на диске, где располагается временный каталог, достаточно места (объем
свободного места должен быть примерно равен двойному объему анализируемых
растров).</p>
<p>В поле &laquo;Output raster&raquo; указывается файл, в который будет
сохранен результат классификации.</p>

<h3>Дополнительные настройки</h3>
<p>Если установить флаг &laquo;Add result to map canvas&raquo;, то по
окончанию процесса результат классификации будет загружен в QGIS. Установка
флага &laquo;Save point layer to disk&raquo; заставит расширение сохранить
тренировочные данные в точечный shape-файл рядом с итоговым файлом. Для
каждой точки в файл записываются значения каналов растра и класс, которому
принадлежит точка. они могут быть использованы для построения модели и
классификации в другом программном обеспечении. </p>
<p>Группа &laquo;Settings&raquo; служит для настройки классификации. Здесь
можно выбрать используемый метод: одиночное дерево решений
(&laquo;Use decision tree&raquo;) или <a href="http://ru.wikipedia.org/wiki/Random_forest" target="_blank" class="external">ансамбль
деревьев</a> (&laquo;Use random forest&raquo;). Обычно, классификация при
помощи ансамбля деревьев дает более точные результаты. При использовании
одиночного дерева становится доступным флаг &laquo;Output values are
discrete class labels&raquo;, установка которого приведет к тому, что
исходные данные будут трактоваться как набор дискретных величин (меток).
Если флаг не установлен, то исходные данные трактуются как непрерывные.</p>
<p>Здесь же можно активировать &laquo;сглаживание&raquo; результатов
классификации с настраиваемым размером окна (&laquo;Generalize result
using kernel size&raquo;). При включенном сглаживании будет создан не один,
а два растра: классифицированный и сглаженный (имя содержит суффикс
&laquo;_smooth&raquo;).</p>

<p>Помимо результатов классификации расширение сохраняет в формате YAML
используемое при классификации дерево (имя файла формируется из имени файла
назначения и суффикса &laquo;_tree&raquo;).</p>

<p>Нажатие кнопки &laquo;Ok&raquo; запустит процесс извлечения
тренировочных данных, обучение классификатора и собственно классификацию.
Ход классификации отображается при помощи двух индикаторов: верхний
отображает прогресс текущей операции, а нижний &nbsp;&mdash; общий прогресс.</p>

<h2><strong><a name="03" id="03"></a></strong>3. Пример: детектирование рубок</h2>
<p>Рассмотрим работу с расширением на примере решения одной из задач
мониторинга лесохозяйственной деятельности: детектировании рубок.</p>
<p>Процесс тематической классификации состоит из нескольких этапов:</p>
<ul>
  <li>поиск и подготовка растровых данных</li>
  <li>сбор тренировочных данных</li>
  <li>построение модели по тренировочным данным</li>
  <li>применение модели к растровым данным и получение результата</li>
</ul>
<h3><strong>Поиск и подготовка растровых данных</strong>
</h3>
<p>Прежде всего необходимо найти и привязать растры, которые в дальнейшем
будут классифицироваться. Обычно, это данные космической съемки (например,
Landsat), на которых хорошо видны интересующие нас объекты. Если вы не знаете
где взять снимки, рекомендуем ознакомиться со статьями, описывающими процесс
<a href="/qa/landsat-glovis.html">получения данных Landsat</a> через сервис
Glovis и их <a href="/qa/qgis-landsat-merge.html">дальнейшую обработку</a>
(а именно, объединение отдельных каналов в единый файл).</p>
<p>Если вы хотите повторить пример, загрузите <a href="/data/samples/dtclassifier-demo.7z">архив</a>
с исходными данными.</p>
<p>Для задачи детектирования рубок возьмем растр after.tif и выставим
комбинацию каналов 5-4-3, чтобы было легче различать рубки (розовые на снимке).</p>

<p align="center"><img src="/images/dtclassifier-06.png" alt="Исходный растр" width="638" height="610"></img></p>

<h3><strong>Сбор тренировочных данных</strong>
</h3>
<p>Для построения дерева решений необходимо подготовить тренировочные данные
(т.н. &laquo;обучение с учителем&raquo;), содержащие объекты двух классов:
присутствие и отсутствие рубок.</p>
<p>Нам необходимо как минимум два векторных слоя: один соответствующий
рубкам, а второй &nbsp;&mdash; местам, где рубок нет. Так, можно создать
два точечных слоя и расставить точки в нужных местах (на рисунке синие точки
соответствуют рубкам, зеленые&nbsp;&mdash; отсутствие рубок).</p>

<p align="center"><img src="/images/dtclassifier-07.png" alt="Тренировочые данные (точки)" width="335" height="351"></img></p>

<p>Но такой способ не очень удобен, поскольку результат классификаци зависит
от количества тренировочных данных (чем их больше, тем точнее результат).
Поэтому, рациональнее создать полигональные слои и обвести несколько рубок,
аналогично поступить и с областями, где их нет (синий цвет соответствует
рубкам, зеленый&nbsp;&mdash; рубок нет).</p>

<p align="center"><img src="/images/dtclassifier-08.png" alt="Тренировочые данные (полигоны)" width="241" height="397"></img></p>

<p>Так как расширение поддерживает все типы геометрии (точки, линии,
полигоны), то можно использовать несколько слоев одновременно. Загрузим
слои рубок presence-poly.shp, presence-poi.shp (полигоны и точки соответственно)
и аналогичные слои с данными об отсутствии рубок&nbsp;&mdash; absence-poly.shp,
absence-poi.shp.</p>

<p>Если включить флаг &laquo;Save point layer to disk&raquo;, то точечный
слой, полученный из исходных тренировочных слоев, будет сохранен для дальнейшего
использования. Например, сохранив атрибутивную таблицу в формат CSV, можно
выполнить классификацию этого же растра в R (<a href="/qa/classify-trees-r.html">подробнее</a>),
а затем сравнить результаты.</p>
<p>Создание точечного слоя и извлечение значений пикселей растра будет
выполняться в автоматическом режиме, после запуска процесса классификации.</p>

<h3><strong>Классификация</strong>
</h3>
<p>После подготовки тренировочных слоёв и исходного растра можно приступать
к анализу. Используя кнопки &laquo;+&raquo; рядом с выпадающими списками
указываем тренировочные слои (наличие рубок&nbsp;&mdash; presence layer;
отсутствие рубок&nbsp;&mdash; absence layer), в списке растров выбираем
растр after.tif, указываем путь для сохранения результатов.</p>
<p>Так как значения пикселей растра являются непрерывными значениями, флаг
&laquo;Output values are discrete class labels&raquo; активировать не нужно.
А вот сглаживание (&laquo;Generalize result using kernel size&raquo;) стоит
включить: это уберет &laquo;шумы&raquo; и сделает результат более четким.
Размер окна по умолчанию (3) в большинстве случаев достаточен.</p>
<p>Нажатием на кнопку &laquo;Ok&raquo; запускаем классификацию. После
непродолжительного ожидания получим два новых растра. </p>
<p>Фрагмент классифицированного растра:</p>

<p align="center"><img src="/images/dtclassifier-09.png" alt="Результат классификации" width="555" height="408"></img></p>

<p>Видно, что много отдельных пикселей было классифицированно как рубки,
хотя на самом деле они не относятся к ним. Для устранения такого &laquo;шума&raquo;
и нужно сглаживание. Ниже показан тот же фрагмент изображения, но уже
после сглаживания:</p>

<p align="center"><img src="/images/dtclassifier-10.png" alt="Сглаженный результат классификации" width="555" height="408"></img></p>

<p>Видим, что одиночных пикселей меньше, а границы рубок стали более четкими.</p>

<h2><strong><a name="04" id="04"></a></strong>4. Пример: анализ изменений</h2>
<p>Еще одной задачей, которую можно решить при помощи DTclassifier является
анализ изменений. Суть такого анализа состоит в том, что берется серия растров
(в простейшем случае&nbsp;&mdash; пара) до и после некоторого события. Затем
выделяются изменившиеся области.</p>
<p>Основные этапы в этом случае точно такие же, как при тематической
классификации, приводить их еще раз мы не будем, а просто на примере разберем
как выполняется анализ изменений при помощи DTclassifier. В качестве исходных
данных возьмем все тот же <a href="/data/samples/dtclassifier-demo.7z">архив</a>
с файлами.</p>
<p>Создадим новый проект в QGIS и загрузим оба растра: before.tif и after.tif.
Как видно из названия, снимок before.tif выполнен до интересующего нас
события (в данном случае&nbsp;&mdash; вырубка леса), а снимок after&nbsp;&mdash;
после. Применив этот подход, мы можем выделить рубки появившиеся в промежуток
между снимками &laquo;до&raquo; и &laquo;после&raquo;.</p>
<p>Сбор тренировочных данных немного отличается от описаного в предыдущем
примере. Если при тематической классификации данные набирались по принципу
признак присутствует / признак отсутствует, то теперь данные отбираются
по двум растрам. В слои изменений (presence) заносятся области, в которых
признак присутствует на снимке &laquo;после&raquo;, но отсутствует на
снимке &laquo;до&raquo;.</p>

<p align="center"><img src="/images/dtclassifier-11.png" alt="Тренировочые данные на снимке до вырубки" width="242" height="401"></img>&nbsp;<img src="/images/dtclassifier-08.png" alt="Тренировочые данные на смнимке после вырубки" width="241" height="397"></img></p>

<p>А вот слои отсутствия признака (absence) формируются, как и в предыдущем
примере, из областей где на обоих снимках интересующий нас признак отсутствует.</p>
<p>В этом примере в качестве тренировочных данных будем использовать только
полигональные слои presence-poly.shp и absence-poly.shp, разумеется,
при необходимости допускается использование нескольих слоёв.</p>
<p>Вызовем главное окно DTclassifier, в выпадающих списках &laquo;Feature
presence layer&raquo; и &laquo;Feature absence layer&raquo; выбираем слои
presence-poly и absence-poly соответственно. В списке исходных растров,
зажав Shift, выделяем оба растра before и after. Указываем куда сохранять
результат, настройки классификации можно оставить без изменений. Нажатием
на кнопку &laquo;OK&raquo; запускаем анализ и ждем его окончания.</p>
<p>Ниже показан фрагмент снимка до вырубки:</p>

<p align="center"><img src="/images/dtclassifier-12.png" alt="До вырубки" width="555" height="406"></img></p>

<p>Тот же участок после рубки:</p>

<p align="center"><img src="/images/dtclassifier-13.png" alt="После рубки" width="555" height="406"></img></p>

<p>Результат анализа наложен на снимок предшествующий вырубке леса:</p>

<p align="center"><img src="/images/dtclassifier-14.png" alt="До вырубки + результат анализа" width="555" height="406"></img></p>

<h2><strong><a name="05" id="05"></a></strong>5. Заключение</h2>
<p>DTClassifier является достаточно простым и функциональным интегрированным расширением
для решения задач классификации растровых данных на два класса (признак
присутствует / признак отсутствует), а также для анализа изменений.
Интеграция с QGIS позволяет быстро модифицировать тренировочные данные,
и подбирать оптимальное их количество, а благодаря использованию библиотеки
компьютерного зрения OpenCV расширение DTClassifier обладает высокой
скоростью работы.</p>

<h2><strong><a name="06" id="06"></a></strong>6. Контакты</h2>
<p>Если вы нашли ошибку, у вас есть предложения по улучшению расширения или
просто вопросы по использованию&nbsp;&mdash; напишите <a href="http://www.nextgis.ru/contact/">нам</a>.</p>
<div style="text-align:center;margin:10px 0;"><a href="http://nextgis.ru" target="_blank"><img height="33" width="100" alt="Комания NextGIS: Создание открытого ПО ГИС и реализация проектов" src="http://nextgis.ru/img/nextgis.png" style="margin: 0pt 7px 0pt 0pt; vertical-align: middle;"></a><strong style="font: bold 11px Arial;">Создание открытого ПО ГИС и реализация проектов</strong></div>

<!-- обсуждение на форуме, цифра изменяется при публикации статьи -->
<p class="discuss"><span><!--#include virtual="/scripts/forum-comments-num.php?i=8172"--></span></p>

<div class="links">
<h2>Ссылки по теме</h2>
<ul>
   <li><a href="http://opencv.willowgarage.com/" target="_blank" class="external">OpenCV Wiki</a></li>
   <li><a href="/qa/classify-trees-r.html">Классификация растровых данных с помощью деревьев решений в R</a></li>
   <li><a href="/qa/imagesvm.html">Классификация данных ДЗЗ используя метод опорных векторов и imageSVM</a></li>
   <li><a href="/qa/burnedarea-opencv.html">Распознавание сгоревших территорий с помощью деревьев решений и OpenCV</a></li>
</ul>
</div>

<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<p class="status"><span>Дата создания: 21.06.2011
<br>Автор(ы): <a href="/forum/memberlist.php?mode=viewprofile&u=5325" target="_blank">Александр Бруй</a>, <a href="/forum/memberlist.php?mode=viewprofile&u=2" target="_blank">Максим Дубинин</a></span></p>
<!--#include virtual="/inc/footer2.php" -->
