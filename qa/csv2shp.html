<!--#include virtual="/inc/header02.txt" -->
<title>GIS-Lab: Конвертация данных из CSV в SHP и обратно с OGR</title>
<!--#include virtual="/inc/header2.txt" -->
<div class="cont">
<div class="col1">

<ul class="path">
   <li class="first"><a href="/">Главная</a></li>
   <li><a href="/qa.html">Вопросы и ответы</a></li>
</ul>
<!--Contents start-->
<h1>Конвертация данных из CSV в SHP и обратно с OGR</h1>
<p class="ann">Рассмотрена конвертация данных из формата CSV в формат ESRI shape и обратно.</p>
            <p><strong>Оглавление</strong></p>
            <ol>
                  <li><a href="#01">Введение</a></li>
                  <li><a href="#02">Формат CSV и особенности драйвера OGR CSV</a></li>
                  <li><a href="#03">Конвертация данных из .csv в .shp</a></li>
                  <li><a href="#04">Конвертация данных из .shp в .csv</a></li>
                  <li><a href="#05"> Примеры программных реализаций</a></li>
            </ol>


<!-- Первый раздел -->
            <p><a name="01" id="01"></a><h2>1. Введение</h2></p>
	    <p>Довольно часто возникает задача конвертации файлов формата csv в  shape-файлы. Иногда возникнает и обратная задача – конвертация shape-файлов  в csv. Две данные операции и будут рассмотрены в этой статье. </p>
	    <p>Эта статья ориентирована на пользователя знакомого с командной строкой. В случае, если необходимо сконвертировать в shape один-другой файл csv, то возможно проще воспользоваться плагином QGIS «Delimited text», однако обратную конвертацию в QGIS выполнить  на данный момент невозможно.</p>
	    <p>Стоит отметить, что до выхода версии GDAL 1.6.0 возможности  конвертировать  шейп-файл в формат csv c сохранением информации о геометрических объектах не было, поэтому советуем обновить вашу версию, если это необходимо.</p>
	    <p>Прежде чем переходить к преобразованию данных из одного  формата в другой, рассмотрим, что же представлят из себя непосредственно формат  CSV и  более детально остановимся на особенностях драйвера OGR CSV. В этом описании  используется информация с <a href="http://gdal.org/ogr/drv_csv.html" target="_blank" class="external">официального  сайта библиотеки GDAL</a>.</p>
	    <!-- Второй раздел -->
            <p><a name="02" id="02"></a><h2>2. Формат CSV и особенности драйвера OGR CSV</h2></p>
	    <p>OGR поддерживает чтение и запись табулированных данных (данных разделенных специальным символом-разделителем),  хранящихся в текстовых файлах формата csv, являющегося распространенным форматом обмена табличными данными между  различными программами. Файл данного типа можно легко создать вручную,  например, с помошью любого текстового редактора.</p>
	    <p>Хотя на практике файл с разделителями может иметь любое  расширение (csv,txt,…), драйвер OGR CSV поддерживает  только файлы с расширением .csv.  Данное требование объясняется тем, что при использовании утилит командной  строки OGR не указывается формат входного файла и поэтому его  формат определяется на основании расширения. Именем источника данных  может быть либо единственный csv файл, либо каталог,  содержащий несколько файлов.  Чтобы каталог  распознался как источник csv данных, необходимо, чтобы по крайней мере половина файлов в каталоге  имела расширение .csv. Из  каждого .csv файла в каталоге генерируется один слой (одна таблица).</p>
	    <p>Драйвер OGR CSV поддерживает как чтение, так и запись. Поскольку файл формата  csv содержит текстовые  строки переменной длины, то чтение выполняется последовательно (строка за  строкой). Слой OGR CSV никогда не имеет описания системы координат. Драйвер OGR CSV возвращает  тип всех полей как строковый, если нет файла описания типов полей (дополнительный  файл с расширением .csvt).</p>
	    <p>Поддерживаемые типы полей - Integer, Real, String, Date  (YYYY-MM-DD), Time  (HH:MM:SS+nn) и DateTime (YYYY-MM-DD HH:MM:SS+nn). Как уже отмечалось, файл с описанием типов полей должен  иметь расширение .csvt и такое же имя, как и файл csv. Типы полей задаются в двойных  кавычках через запятую в одну строку (например, &quot;Integer&quot;,&quot;String&quot;). Также возможно непосредственно  указать ширину и точность каждого поля (например, &quot;Integer(5)&quot;,&quot;Real(10.7)&quot;,&quot;String(15)&quot;). </p>
	    <p>В файле csv  каждая строка описывает отдельный объект в слое  (таблице). Значения полей отделены друг от друга запятыми. В каждой строке  должно быть минимум 2 поля. Строки  отделены друг от друга разделителями в стиле DOS (CR/LF) или в стиле Unix (LF). Каждая строка должна иметь  одинаковое количество полей. Начиная с версии GDAL 1.7.0,  драйвер также поддерживает в качестве разделителей между полями – точку с  запятой или табуляцию. Это автоопределение будет работать только в том случае,  если в первой строке нет других потенциально возможных разделителей. В  противном случае в качестве разделителя будет использована запятая.</p>
	    <p>Составные значения полей (например, содержащие запятые,  кавычки) следует помещать в двойные кавычки. Если в значении поля содержатся  кавычки, то их следует удвоить.</p>
	    <p>Драйвер пытается обработать первую строку файла как список  имен всех полей. Однако, если одно из полей имеет числовое значение – то  подразумевается, что в первой строке содержатся данные, описывающие отдельный объект,  а в качестве имен полей используются имена field_1, field_2  и т.д.</p>
	    <p>Пример (employee.csv):</p>
	    <pre>ID,Salary,Name,Comments
132,55000.0,John Walker,"The ""big"" cheese."
133,11000.0,Jane Lake,Cleaning Staff
</pre>

        <p>
          <!-- Конец текста статьи, начало ссылок -->
          Встречаются текстовые файлы, часто называемые csv, включающие данные не разделенные запятыми, а с фиксированной шириной поля. Данный драйвер не поддерживает  подобный формат. Если у вас такие данные, преобразуйте их в простой .csv фомат,  чтобы он стал понятен драйверу OGR CSV.</p>
        <p><a name="03" id="022"></a><h2>3. Конвертация данных из .csv в .shp</h2></p>
        <p>Одна из существенных возможностей  OGR - извлечение пространственной  информации из файла csv . В  случае, если csv файл содержит поля в которых хранятся X и Y координаты  точек, то конвертировать такой файл csv  в shape-файл можно посредством использования промежуточного драйвера VRT. Описание этого драйвера  и всех его параметров доступно на <a href="http://gdal.org/ogr/drv_vrt.html" target="_blank" class="external">официальном  сайте</a>.</p>
        <p>Рассмотрим следующий файл csv   (test.csv):</p>
        <pre>Latitude,Longitude,Name
48.1,0.25,"First point"
49.2,1.1,"Second point"
47.5,0.75,"Third point"
</pre>
        <p>Создадим соответствуюший файл vrt  (test.vrt):</p>
        <pre>&lt;OGRVRTDataSource&gt;
    &lt;OGRVRTLayer name="test"&gt;
        &lt;LayerSRS&gt;WGS84&lt;/LayerSRS&gt;
        &lt;SrcDataSource&gt;test.csv&lt;/SrcDataSource&gt;
        &lt;GeometryType&gt;wkbPoint&lt;/GeometryType&gt;
        &lt;GeometryField encoding="PointFromColumns" x="Longitude" y="Latitude"/&gt;
    &lt;/OGRVRTLayer&gt;
&lt;/OGRVRTDataSource&gt;
</pre>
        <p>и  выполним команду:</p>
        <pre>ogr2ogr output test.vrt</pre>
<p>Будет создана папка с названием output, а в нее добавлен файл test.shp.</p>
<p>Если же видоизменить команду:</p>
<pre>ogr2ogr output.shp test.vrt</pre>
<p>то shape-файл с именем output.shp будет создан в текущей папке.</p>
<p>В случае, если файл csv  (test.csv) содержит поле в котором хранится  описание геометрии объекта в формате WKT:</p>
<pre>GeomField,Code
"POLYGON((1 2,3 4, 2 1))&quot;,8
"POLYGON((11 21,31 41, 21 11))&quot;,9
</pre>
<p>то чтобы конвертировать его в  shape-файл нужно отредактировать файл vrt  (test.vrt):</p>
<pre>&lt;OGRVRTDataSource&gt;
    &lt;OGRVRTLayer name="test"&gt;
        &lt;SrcDataSource&gt;test.csv&lt;/SrcDataSource&gt;
        &lt;GeometryType&gt;wkbUnknown&lt;/GeometryType&gt;
        &lt;GeometryField encoding="WKT" field="GeomField"/&gt;
    &lt;/OGRVRTLayer&gt;
&lt;/OGRVRTDataSource&gt;
</pre>
<p>То есть мы заменили encoding=&quot;PointFromColumns&quot;  на encoding=&quot;WKT&quot;  и указали поле, в котором содержится описание геометрии в WKT-формате field=&quot; GeomField &quot;. И после выполнения команды ogr2ogr как показано выше, мы получим шейп  файл, соответствующей геометрии, в котором помимо остальных в качестве  атрибутивного поля будет содержаться поле с WKT-представлением объектов. В связи с ограничением, накладываемым на размер атрибутивного текстового поля (255 символов) shape-файла, информация о WKT-представлении может оказаться обрезанной. Это не повлияет на саму геометрию, а только на ее копию в атрибутивном поле. </p>
<p>Если поле с WKT описанием геометрии в файле csv  имеет имя WKT, например такой: </p>
<pre>WKT,Code
"POLYGON((1 2,3 4, 2 1))&quot;,8
"POLYGON((11 21,31 41, 21 11))&quot;,9
</pre>
<p>то можно обойтись без использования  драйвера VRT. В этом  случае конвертация из csv в shape выполняется командой:</p>
<pre>ogr2ogr output.shp test.csv</pre>
<p>Таким образом, что бы получить CSV файл,  который легко перевести в shape-файл,  нужно правильно заполнить одну из колонок csv файла WKT-описанием геометрии.</p>
<p><a name="04" id="0222"></a><h2>4. Конвертация данных из .shp в .csv</h2></p>
<p>Конвертация  данных из  шейп файла также выполняется  утилитой ogr2ogr. Опции  создания csv файла:</p>
<ul type="ring">
  <li><strong>LINEFORMAT</strong>: По умолчанию,       при создании нового csv файла в качестве разделителя строк используется символ в       зависимости от текущей платформы (CR/LF под win32       или LF для других). Данный параметр может быть переопределен с       использованием ключа  LINEFORMAT, который       может принимать значение CRLF       (DOS формат) или LF (Unix формат).</li>
  <li><strong>GEOMETRY</strong> (Начиная с версии       GDAL 1.6.0): По умолчанию,       представление геометрии не записывается в csv файл.       Существует возможность экспортировать геометрию в представление WKT, определив ключ  GEOMETRY=AS_WKT. Также возможно экспортировать       точечную геометрию в X,       Y, Z компоненты       (отдельные поля .csv файла), определив ключ  GEOMETRY=AS_XYZ, GEOMETRY=AS_XY или GEOMETRY=AS_YX. Поля с описанием геометрии будут располагаться перед атрибутивными полями </li>
  <li><strong>CREATE_</strong><strong>CSVT</strong>=YES/NO (Начиная с версии GDAL 1.7.0): создание связанного       .csvt файла для описания типов полей. Значение по умолчанию NO. </li>
  <li><strong>SEPARATOR</strong>=COMMA/SEMICOLON/TAB       (Начиная с версии GDAL 1.7.0): Символ разделения полей. Значение       по умолчанию : COMMA.</li>
</ul>
<p>Пример конвертации  шейп файла в csv:</p>
<pre>ogr2ogr -f CSV output input.shp -lco GEOMETRY=AS_WKT -lco CREATE_CSVT=YES</pre>
<p>В результате выполнения данной команды в текущей директории  будет создан каталог output и в него помещен файл input.csv,  содержащий поле с WKT-представлением  геометрических объектов, а также файл input.csvt c описанием типов полей csv файла.<br>
  <br>
  Отметим, что ключ -f используется при  конвертировании шейп файла в csv в то время как при конвертации csv в шейп  данный ключ не используется. Это происходит потому, что выходной формат по умолчанию  «ESRI Shapefile», что равносильно  строке  -f «ESRI Shapefile».</p>
<p><a name="04" id="0222"></a></p>
<h2>5. Примеры программных реализаций</h2>
<p><a href="/programs/perl/csv2shp-ogr.txt">Perl</a> - обрабатывает все файлы в папке (csv), создает vrt и  генерирует shape-файлы каждый в своей папке. 
  Условие - во всех файлах lat и long столбцы должны называтся одинаково. <br>
  Протестировано для точечных слоев на Suse 11. </p>
<p><a href="/programs/python/csv2shp.7z">Python</a> - обрабатывает все файлы в папке (csv), создает vrt и  генерирует shape-файлы.</p>
<p>  <span>
    <!--#include virtual="/scripts/forum-comments-num.php?i=3805"-->
  </span>		</p>
<p>&nbsp;</p>
<div class="links">
				<h2>Ссылки по теме</h2>
					<ul>
						<li><a href="ogr2ogr-examples.html">Примеры использования ogr2ogr</a></li>
                        <li><a href="http://gdal.org/ogr/drv_vrt.html" class="external">OGR Virtual Format</a></li>
						<li><a href="http://gdal.org/ogr/drv_csv.html" target="_blank" class="external">Comma Separated Value (.csv)</a></li>
					</ul>
			</div>
<!--Contents end-->
<!--#include virtual="/scripts/date.php" -->
<!--#include virtual="/inc/footer2.php" -->
